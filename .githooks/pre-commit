#!/bin/bash

# Pre-commit hook for automatic code formatting
# This script runs:
# 1. spotless:apply for Java projects (ai-rag-knowledge, openai-code-review)
# 2. eslint --fix for the openai-frontend project

set -e

PROJECT_ROOT="$(git rev-parse --show-toplevel)"
cd "$PROJECT_ROOT"

echo "üîç Running pre-commit linting and formatting..."

# 1. Run spotless on Java projects
echo "üì¶ Running spotless formatting for Java projects..."
# ÂÆö‰πâ Java Â≠êÊ®°ÂùóÂàóË°®
JAVA_MODULES=("ai-rag-knowledge" "openai-code-review")

for module in "${JAVA_MODULES[@]}"; do
    if [ -f "$module/pom.xml" ]; then
        echo "üì¶ Running spotless formatting in $module..."
        (cd "$module" && mvn spotless:apply -q)
    else
        echo "‚ö†Ô∏è  No pom.xml found in $module, skipping"
    fi
done
echo "‚úÖ Java formatting completed"

# 2. Run ESLint on openai-frontend
if [ -d "openai-frontend" ]; then
    echo "üé® Running ESLint for openai-frontend..."
    cd openai-frontend
    
    # Check if node_modules exists, if not skip linting
    if [ -d "node_modules" ]; then
        if ! npx eslint --fix . 2>/dev/null; then
            echo "‚ö†Ô∏è  ESLint found issues (some may be auto-fixed)"
        fi
        echo "‚úÖ Frontend linting completed"
    else
        echo "‚ö†Ô∏è  node_modules not found in openai-frontend, skipping ESLint"
    fi
    
    cd "$PROJECT_ROOT"
fi

# Stage all formatted files
git add -A

echo "‚úÖ All code formatting completed successfully"
exit 0
